rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // =================================================================================
    // üõ°Ô∏è KERNEL DE SEGURAN√áA (STORAGE)
    // =================================================================================

    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // =================================================================================
    // üë§ PERFIS (Avatars)
    // =================================================================================
    
    // Permite que o usu√°rio fa√ßa upload apenas na sua pr√≥pria pasta de avatar
    // Caminho: avatars/users/{userId} ou avatars/admin/{userId}
    match /avatars/{role}/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }

    // =================================================================================
    // üè´ PROFESSOR (Conte√∫do & Turmas)
    // =================================================================================

    // Capas de Turmas
    match /class_covers/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }

    // Capas de M√≥dulos
    match /module_covers/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }

    // Imagens internas de M√≥dulos (Editor de Conte√∫do)
    match /module_content_images/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }

    // Anexos de Atividades (PDFs, Imagens auxiliares para download)
    // Caminho usado: activity_attachments/{classId}/{userId}/{fileName}
    // Obs: Como o folderId pode ser 'drafts' ou um ID de turma, usamos wildcards
    match /activity_attachments/{folderId}/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }
    
    // Assets para Atividades Interativas (Imagens de fundo para Hotspots, etc)
    match /activity_assets/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }

    // =================================================================================
    // üéì ALUNO (Submiss√µes)
    // =================================================================================

    // Envios de arquivos em respostas de atividades
    match /student_submissions/{activityId}/{studentId}/{allPaths=**} {
      // Leitura permitida para autenticados (Professor precisa baixar para corrigir)
      allow read: if isAuthenticated();
      // Escrita apenas pelo pr√≥prio aluno
      allow write: if isUser(studentId);
    }
  }
}