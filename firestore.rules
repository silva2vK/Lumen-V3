
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================================
    // üõ°Ô∏è KERNEL DE SEGURAN√áA
    // =================================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isTeacher() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'professor';
    }

    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper para verificar campos imut√°veis
    function notUpdating(field) {
      return !(field in request.resource.data) || resource.data[field] == request.resource.data[field];
    }

    // =================================================================================
    // üìù ACTIVITIES (Atividades)
    // =================================================================================

    match /activities/{activityId} {
      // LEITURA: Permitida para autenticados.
      allow read: if isAuthenticated();
      
      // ESCRITA: Apenas Professores e Admins
      allow create, delete: if isTeacher() || isAdmin();
      
      // ATUALIZA√á√ÉO: 
      // 1. Professores/Admins podem editar tudo.
      // 2. Alunos podem atualizar APENAS os contadores de submiss√£o (incremento).
      allow update: if isTeacher() || isAdmin() || (
        isAuthenticated() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['submissionCount', 'pendingSubmissionCount'])
      );

      // SUB-COLE√á√ÉO: SUBMISS√ïES
      match /submissions/{submissionId} {
        // Regra vital para acesso direto (get) ou via query (list)
        allow read: if isAuthenticated() && (
          submissionId == request.auth.uid || 
          (resource != null && resource.data.studentId == request.auth.uid) ||
          isTeacher() || 
          isAdmin()
        );

        // Aluno pode criar/editar APENAS sua pr√≥pria submiss√£o
        // Verifica se o ID no documento corresponde ao usu√°rio logado
        allow create: if isUser(request.resource.data.studentId);
        
        allow update: if isUser(resource.data.studentId) && notUpdating('grade');
      }
    }

    // Regra espec√≠fica para COLLECTION GROUP queries (Global)
    match /{path=**}/submissions/{submissionId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacher() ||
        isAdmin()
      );
    }

    // =================================================================================
    // üë§ USU√ÅRIOS E OUTROS
    // =================================================================================

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
      
      match /quiz_results/{quizId} { allow read, write: if isUser(userId); }
      match /modulesProgress/{moduleId} { allow read, write: if isUser(userId); }
      match /read_notifications/{notifId} { allow read, write: if isUser(userId); }
    }

    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    match /modules/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }
    match /module_contents/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }
    match /quizzes/{quizId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
      match /answers/{docId} { allow read, write: if isTeacher() || isAdmin(); }
    }

    // Outros
    match /achievements/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /userAchievements/{userId} { allow read: if isAuthenticated(); allow write: if isUser(userId) || isAdmin(); }
    match /student_grades/{id} { allow read: if isAuthenticated(); allow write: if isTeacher() || isAdmin(); }
    match /notifications/{id} { allow read: if isUser(resource.data.userId); allow write: if isAuthenticated(); }
    match /broadcasts/{id} { allow read: if isAuthenticated(); allow write: if isTeacher() || isAdmin(); }
    match /invitations/{id} { allow read, write: if isAuthenticated(); }
    match /attendance_sessions/{id} { allow read, write: if isAuthenticated(); }
    match /attendance_sessions/{sessionId}/records/{recordId} { allow read, write: if isAuthenticated(); }
    match /system_settings/{id} { allow read: if true; allow write: if isAdmin(); }
    match /teacher_history/{userId} { allow read, write: if isUser(userId); }
  }
}
