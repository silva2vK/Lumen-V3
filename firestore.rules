
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================================
    // üõ°Ô∏è KERNEL DE SEGURAN√áA
    // =================================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isTeacher() {
      // Verifica se o token de auth possui a claim de professor OU l√™ do documento (mais lento, mas seguro)
      // Para performance, assumimos leitura do documento do usu√°rio atual
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'professor';
    }

    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // =================================================================================
    // üìù ACTIVITIES (Atividades)
    // =================================================================================

    match /activities/{activityId} {
      // LEITURA: Permitida para autenticados. O filtro real de seguran√ßa √© feito na Query do Frontend (where classId in myClasses).
      allow read: if isAuthenticated();
      
      // ESCRITA: Apenas Professores e Admins
      allow create, delete: if isTeacher() || isAdmin();
      
      // ATUALIZA√á√ÉO: Professores (tudo) ou Alunos (apenas contadores, se necess√°rio via client, mas idealmente via Cloud Function)
      allow update: if isTeacher() || isAdmin();

      // SUB-COLE√á√ÉO: SUBMISS√ïES (Onde ocorre o erro de Collection Group)
      match /submissions/{submissionId} {
        // Regra vital para acesso direto (get) ou via query (list)
        // 1. Se for o pr√≥prio aluno (pelo ID do documento ou pelo campo studentId)
        // 2. Se for professor ou admin
        allow read: if isAuthenticated() && (
          submissionId == request.auth.uid || 
          (resource != null && resource.data.studentId == request.auth.uid) ||
          isTeacher() || 
          isAdmin()
        );

        // Aluno pode criar/editar APENAS sua pr√≥pria submiss√£o
        allow create: if isUser(request.resource.data.studentId);
        allow update: if isUser(resource.data.studentId) && notUpdating('grade'); // Aluno n√£o pode mudar a nota
      }
    }

    // Regra espec√≠fica para COLLECTION GROUP queries (Global)
    // Isso garante que queries como db.collectionGroup('submissions') funcionem se filtrarem por studentId
    match /{path=**}/submissions/{submissionId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacher() ||
        isAdmin()
      );
    }

    // =================================================================================
    // üë§ USU√ÅRIOS E OUTROS
    // =================================================================================

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
      
      match /quiz_results/{quizId} { allow read, write: if isUser(userId); }
      match /modulesProgress/{moduleId} { allow read, write: if isUser(userId); }
      match /read_notifications/{notifId} { allow read, write: if isUser(userId); }
    }

    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    match /modules/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }
    match /module_contents/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }
    match /quizzes/{quizId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
      match /answers/{docId} { allow read, write: if isTeacher() || isAdmin(); }
    }

    // Outros
    match /achievements/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /userAchievements/{userId} { allow read: if isAuthenticated(); allow write: if isUser(userId) || isAdmin(); }
    match /student_grades/{id} { allow read: if isAuthenticated(); allow write: if isTeacher() || isAdmin(); }
    match /notifications/{id} { allow read: if isUser(resource.data.userId); allow write: if isAuthenticated(); }
    match /broadcasts/{id} { allow read: if isAuthenticated(); allow write: if isTeacher() || isAdmin(); }
    match /invitations/{id} { allow read, write: if isAuthenticated(); }
    match /attendance_sessions/{id} { allow read, write: if isAuthenticated(); }
    match /attendance_sessions/{sessionId}/records/{recordId} { allow read, write: if isAuthenticated(); }
    match /system_settings/{id} { allow read: if true; allow write: if isAdmin(); }
    match /teacher_history/{userId} { allow read, write: if isUser(userId); }

    // Helper para verificar campos imut√°veis
    function notUpdating(field) {
      return !(field in request.resource.data) || resource.data[field] == request.resource.data[field];
    }
  }
}
